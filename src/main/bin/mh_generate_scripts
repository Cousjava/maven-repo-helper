#!/bin/bash
# Generate some of the build and installation scripts

find_poms() {
    if [ ! -f debian/$PACKAGE.poms ]; then
        find . -path '*/.*' -prune -o -type f -print | grep -e /pom\.xml$ | grep -v "debian/tmp" | sed s,./,, > debian/$PACKAGE.poms
    fi
    cat debian/$PACKAGE.poms
}

PACKAGE=$1
VERSION_PROPERTIES_FILE=$2

if [ -z "$PACKAGE" ]; then
    echo "Syntax:"
    echo "mh_generate_scripts <binary package> [versions properties file]"
    exit 1
fi
if [ -z "$VERSION_PROPERTIES_FILE" ]; then
    VERSION_PROPERTIES_FILE="debian/tmp/versions.properties"
fi

# Automatic execution of mh_cleanpom to fill versions.properties
if [ ! -f "$VERSION_PROPERTIES_FILE" ]; then
    echo "$VERSION_PROPERTIES_FILE not found, trying to generate it by executing"
    echo "mh_cleanpom on all pom.xml files"
    find_poms | while read POM; do
        echo "mh_cleanpom $POM"
        mh_cleanpom $POM
    done
fi

echo_script() {
    echo "#!/bin/sh"
    echo "set -e"
    echo "LIBRARIES=\"$(cat $VERSION_PROPERTIES_FILE | grep -v ^#.* | sed s/\.version=/' '/ | tr '\n' ',')\""
    echo "PACKAGE=\"$PACKAGE\""
    cat /usr/share/maven-repo-helper/post$DO.tmpl
}

DO="inst"
echo_script > debian/$PACKAGE.post$DO
echo "debian/$PACKAGE.post$DO generated"
DO="rm"
echo_script > debian/$PACKAGE.post$DO
echo "debian/$PACKAGE.post$DO generated"

BIN_PACKAGE="\$(PACKAGE)"
SOURCE=$(dpkg-parsechangelog | egrep '^Source:' | cut -f2 -d' ')
if [ "lib$SOURCE-java" = "$PACKAGE" ]; then
    BIN_PACKAGE="lib\$(PACKAGE)-java"
elif [ "$SOURCE-java" = "$PACKAGE" ]; then
    BIN_PACKAGE="\$(PACKAGE)-java"
fi

echo ""
echo "Add the following lines to debian/rules"
echo "You may need to correct manually some details"
echo ""
echo "PACKAGE			:= \$(DEB_SOURCE_PACKAGE)"
echo "VERSION			:= \$(DEB_UPSTREAM_VERSION)"
echo ""
echo "binary-post-install/$BIN_PACKAGE::"

if [ -f debian/tmp/pom.properties ]; then
    source debian/tmp/pom.properties
fi
find_poms | while read POM; do
    if [[ "$POM" = "pom.xml" || "$POM" = "debian/pom.xml" ]]; then
        echo "    mh_installpom --debian-parent -p$BIN_PACKAGE $POM"
        echo "    mh_installjar -p$BIN_PACKAGE $POM build/\$(PACKAGE)-\$(VERSION).jar usr/share/java/\$(PACKAGE)-\$(VERSION).jar usr/share/java/\$(PACKAGE).jar"
    elif [ ! -z "$POM" ]; then
        BASENAME=$(basename $(dirname $POM))
        echo "    mh_installpom -p$BIN_PACKAGE $POM"
        echo "    mh_installjar -p$BIN_PACKAGE $POM build/\$(PACKAGE)-\$(VERSION).jar usr/share/java/$BASENAME-\$(VERSION).jar usr/share/java/\$(PACKAGE).jar"
    fi
done